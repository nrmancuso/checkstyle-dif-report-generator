name: Generate ANTLR Regression Reports

on:
  workflow_call:
    inputs:
      patch-branch:
        description: 'The branch to generate the report for'
        required: true
        type: string

jobs:
  download-and-commit-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download reports
        uses: actions/download-artifact@v3
        with:
          path: temp-reports

      - name: List reports
        run: |
          echo "PWD" && pwd
          echo "LS:" && ls
          echo "LS -R:" && ls -R

      - name: Setup reports to be committed
        run: |
          
          REPORT_DIR="reports/${{ inputs.patch-branch }}/$(date +'%Y-%m-%d-T-%H-%M-%S')"
          mkdir -p $REPORT_DIR
          cp -r temp-reports/* $REPORT_DIR
          rm -rf temp-reports
          echo "LS -R:" && ls -R $REPORT_DIR

      - name: Create PR with reports
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "reports: create reports for ${{ inputs.patch-branch }}"
          title: "reports: create reports for ${{ inputs.patch-branch }}"
          body: "Creates reports for ${{ inputs.patch-branch }}"
          branch: "reports/${{ inputs.patch-branch }}"
          base: "main"
          delete-branch: true
